<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>テキスト保存＆リンク起動PWA</title>
  <meta name="theme-color" content="#0b1020" />
  <!-- 静的 manifest（start_url なし / Android向け簡易対応） -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root { color-scheme: light dark; }
    *{box-sizing:border-box}
    html,body{margin:0;background:#0b1020;color:#e5e7eb;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 112px}
    h1{font-size:18px;margin:12px 0 8px;font-weight:700}
    .card{background:#0f172a;border:1px solid #23324d;border-radius:16px;padding:12px}
    textarea{
      width:100%;min-height:140px;border:1px solid #2b3b5a;border-radius:12px;
      background:#0b1222;color:#e5e7eb;padding:12px;outline:none;resize:vertical;font-size:16px !important;
    }
    input[type="text"], input[type="url"]{
      width:100%;border:1px solid #2b3b5a;border-radius:12px;background:#0b1222;color:#e5e7eb;
      padding:12px;font-size:16px !important;outline:none;
    }
    .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid #263755;background:#16233d;color:#e5e7eb;
      padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;font-size:15px;
      transition:transform .02s ease,opacity .2s ease;user-select:none
    }
    .btn:active{transform:scale(.98)}
    .btn.copy{background:#1e3a8a;border-color:#3655a8}
    .btn.danger{background:#5b1e2a;border-color:#8a3647}
    .grid{
      display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px
    }
    @media (min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (min-width:840px){ .grid{grid-template-columns:repeat(4,1fr)} }
    .linkbtn{
      display:block;text-align:center;text-decoration:none;color:#e5e7eb;background:#17253f;
      border:1px solid #2a3e62;border-radius:14px;padding:16px;min-height:64px;
      font-weight:700;line-height:1.2;word-break:break-word
    }
    .hint{opacity:.75;font-size:12px;margin-top:6px}
    .muted{opacity:.7}
    .empty{opacity:.8;background:#0e1425;border:1px dashed #2b3b5a;border-radius:12px;padding:12px}
    /* builder list */
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      background:#0b1222;border:1px solid #2b3b5a;border-radius:12px;padding:10px
    }
    .item .meta{min-width:0}
    .item .ttl{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .url{font-size:12px;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    /* トースト */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#e5e7eb;border:1px solid #374151;
      padding:10px 14px;border-radius:999px;opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:1000
    }
    .toast.show{opacity:1}
    /* 安全領域 */
    @supports (padding: max(0px)) {
      .wrap{padding-bottom: max(112px, env(safe-area-inset-bottom))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>testメモ（自動保存・ワンタップコピー）</h1>
    <div class="card">
      <textarea id="memo" placeholder="ここにテキストを入力…（入力と同時に自動保存されます）"></textarea>
      <div class="row">
        <button id="copyBtn" class="btn copy">このテキストをコピー</button>
        <button id="clearBtn" class="btn" title="内容を消去してもストレージは残ります">消去</button>
      </div>
      <div class="hint">
        URLパラメータ例：<code>?text=初期テキスト</code>
      </div>
    </div>

    <!-- パラメータ無し時の説明 -->
    <div id="desc" class="card" style="display:none;margin-top:12px">
      <div class="muted">
        <p style="margin:0 0 6px">
          下の<strong>カスタムURL作成</strong>でボタン（タイトルとリンク）を追加し、生成されたURLをコピーして共有/ブックマークすると、<strong>リンク起動</strong>に四角いボタンが表示されます。
        </p>
        <div class="hint">
          形式例：<code>?btn=タイトル1|https://example.com&amp;btn=タイトル2|https://example.org</code>
        </div>
      </div>
    </div>

    <!-- パラメータ有り時のみ表示 -->
    <section id="linkSection" style="display:none">
      <h1>リンク起動（URLパラメータで定義）</h1>
      <div id="links" class="grid"></div>
      <div class="card hint">
        例）<code>?btn=X|https://46memorybit.github.io/SNSPWA/X/index.html&amp;btn=歌ネット|https://www.uta-net.com/song/382246/&amp;btn=USEN|https://usen.oshireq.com/song/6299592</code><br/>
        <small>※ <strong>btn=タイトル|URL</strong> を複数回指定できます。</small>
      </div>
    </section>

    <!-- ビルダー -->
    <h1 style="margin-top:16px">カスタムURL作成（パラメータ付きURLを生成してコピー）</h1>
    <div class="card">
      <div class="row">
        <input id="builderTitle" type="text" inputmode="text" autocomplete="off" placeholder="タイトル（例：X）" />
        <input id="builderUrl" type="url" inputmode="url" autocomplete="off" placeholder="リンク（https:// から）" />
        <button id="builderAdd" class="btn">追加</button>
      </div>
      <div class="hint">ベースURL：<code id="baseUrl">https://46memorybit.github.io/sns/index.html</code></div>

      <div id="builderEmpty" class="empty" style="margin-top:10px;display:none">
        まだ項目がありません。タイトルとリンクを入力して「追加」を押してください。
      </div>

      <div id="builderList" class="list" aria-live="polite"></div>

      <div class="row" style="justify-content:space-between;margin-top:14px">
        <div class="hint" id="builderCount"></div>
        <button id="builderCopy" class="btn copy">カスタムURLをコピー</button>
      </div>
      <div class="hint">コピーされるURLには <code>btn=タイトル|URL</code> が複数並びます。</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="./db.js"></script>
  <script src="./app.js"></script>

  <!-- ✅ iOSでも確実に：現在のクエリを start_url に焼き込む「動的 manifest」を生成して差し替え -->
  <script>
    (function(){
      // いま開いている検索クエリ（?btn=... を含む）
      const q = location.search || '';
      // その場で manifest JSON を作成（start_url にクエリを埋め込む）
      const dyn = {
        name: "テキスト保存＆リンク起動PWA",
        short_name: "メモ&リンク",
        start_url: "./index.html" + q,  // ← クエリを固定
        scope: "./",
        display: "standalone",
        background_color: "#0b1020",
        theme_color: "#0b1020",
        icons: [
          { src: "assets/icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
          { src: "assets/icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
        ]
      };
      const url = URL.createObjectURL(new Blob([JSON.stringify(dyn)], {type: 'application/manifest+json'}));

      // 既存の <link rel="manifest"> を置き換え（※Safariでも拾ってくれるケースが多い）
      let link = document.querySelector('link[rel="manifest"]');
      if (!link) {
        link = document.createElement('link');
        link.rel = 'manifest';
        document.head.appendChild(link);
      }
      link.href = url;
    })();
  </script>

  <script>
    // PWA Service Worker 登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
